<!DOCTYPE html>
<html ng-app="app" ng-init = "lang='mar'">
	<head>
	  	<meta charset="utf-8">
	  	<meta name="viewport" content="width=device-width, initial-scale=1">
	    <title><%= title %> Article</title>
	    <link rel="stylesheet" href="/stylesheets/numpad.css" />
		<link href="/stylesheets/bootstrap.min.css" rel="stylesheet"/>

		<link href="/bower_components/bootstrap-toggle/css/bootstrap-toggle.min.css" rel="stylesheet"/>
		
	    <script src="/javascripts/jquery-1.11.2.min.js" type="text/javascript"></script>
	    <script src="/bower_components/angular/angular.js"></script>
	    <script src="/bower_components/angular-route/angular-route.min.js"></script>
		<script src="/javascripts/js.cookie-2.1.1.min.js" type="text/javascript"></script>
		 
	    <script src="/bower_components/angular-cookies/angular-cookies.js"></script>
		<script src="/bower_components/angular-bootstrap/ui-bootstrap.min.js"></script>

		<script src="/bower_components/bootstrap-toggle/js/bootstrap-toggle.min.js"></script>
		<script src="/javascripts/numpad.js" type="text/javascript"></script>
		<script src="/javascripts/includes.js" type="text/javascript"></script>

		<style type="text/css">
			body {
			   font-size: 22px;
			}
		</style>
  	</head>
	<body>
		
		<nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="container-fluid">
				<div class="navbar-header">
	      			<button class=" btn" style="margin-top:8px;" onclick="window.history.back();">
						<b>&#8678;</b> Back
					</button>
				</div>
				<div class="nav navbar-nav navbar-right" style="padding: 10px;">
					<input type="checkbox" id="langToggle">
				</div>
			</div>
		</nav>
		<br>
		<br>
		
		<ng-view></ng-view>
		<script type="text/ng-template" id="/home.html">
			<div class="container">
				<h2>{{New}} {{Article}} :</h2>
				<div class="row">
					<div class="col-lg-2 col-md-0 col-sm-0">
					</div>
					<div class = "col-lg-8 col-md-12 col-sm-12">
						<div class="btn btn-warning col-md-5 col-sm-5 col-lg-5" onclick="window.location.href='#/Gold'">
							<img src="../images/gold.png"/>
							<h2>{{gold}}</h2>
						</div>
						<div class="col-lg-2 col-md-2  col-sm-2">
						</div>
						<div class="col-lg-5 col-md-5 btn col-sm-5 btn-info" onclick="window.location.href='#/Silver'">
							<img src="../images/silver.png"/>
							<h2>{{silver}}</h2>
						</div>
					</div>
					<div class="col-lg-2 col-md-1 col-sm-0">
					</div>
				</div>
			</div>
	  	</script>
	  	
	  	<script type="text/ng-template" id="/categories.html">
		  	<div class="container">
					<div class="col-lg-2 pull-right">
			  			<button ng-click="onCat()" class="btn btn-primary btn-md">Add {{New}} {{Category}}</button>
			  		</div>
			  	
		  		<h2>{{New}} {{metal}} {{Article}} {{Category}}:</h2>
				<div ng-repeat="card in categories">
					<a ng-href="/add/#/{{metal_eng}}/{{card._id}}" >
						<div class="btn {{btnClass}} col-xs-8 col-sm-4 col-md-2 col-lg-2" style="margin :5px;">
		    				<h3>{{card.name}}</h3>
		    				<img data-ng-src="data:image/png;base64,{{card.image}}" style="width: 100%"/>
						</div>
					</a>
				</div>
		</script>
	  	<script type="text/ng-template" id="/add_category.html">
			<div class="container">
				<h2>{{New}} {{metal}} Category</h2>
				<form class="form-horizontal" ng-submit="submitForm()" role="form">
				<!-- method="post" action="/api/stock/">-->
					<div class="form-group">
	    				<label class="control-label	col-lg-3" for="metalTxt">English Name:</label>
					    <div class="col-lg-9">
							<input type="text" ng-model="engVal" required="true" class="input-lg form-control" id="engTxt">
						</div>
	  				</div>
	  				<div class="form-group">
	    				<label class="control-label	col-lg-3" for="metalTxt">Marathi Name:</label>
					    <div class="col-lg-9">
							<input type="text" ng-model="marVal" class="input-lg form-control" id="marTxt">
						</div>
	  				</div>
	  				<div id="img_grp" class="form-group">
	    				<label class="control-label	col-lg-3" for="metalTxt">Image file:</label>
					    <div class="col-lg-9">
							<input type="file" required="true"  ng-model="imageVal" class="has-feedback input-lg form-control" id="imgTxt">
						</div>
						<span class="hide" id="img_err_msg">Please select a Valid Image</span>
	  				</div>
	  				<!--<input type="hidden" ng-model="image_dataURI" id="image_uri" value=""></input>-->
	  				<div class="row">
	  					<img id="img_place" class="col-lg-3">
	  					<button type="submit" id="sbt_btn" class="center-block btn btn-primary btn-lg">Upload</button>
	  				</div>
			  	</form>
			</div>
			<script>
				function EL(id) { return document.getElementById(id); } // Get el by ID helper function

				function readFile() {
				  if (this.files && this.files[0]) {
				    var FR= new FileReader();
				    FR.onload = function(e) {
					    $("#img_place").attr("src",e.target.result);
						window.image_uri = (e.target.result);
						window.mime = base64MimeType(e.target.result);
						if(window.mime.split("/")[0] != "image"){
							$("#img_grp")
								.addClass("has-error")
								.removeClass("has-success");
							$("#img_err_msg")
								.removeClass("hide");
							$("#imgTxt").val("");
						}else{
							$("#img_grp")
								.removeClass("has-error")
								.addClass("has-success");
							$("#img_err_msg")
								.addClass("hide");
						}
				    };       
				    FR.readAsDataURL(this.files[0]);
				  }
				}
				function base64MimeType(encoded) {
				  if (!encoded) return;
				  var mime = encoded.match(/data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+).*,.*/);

				  if (mime && mime.length) return mime[1];
				}
				EL("imgTxt").addEventListener("change", readFile, false);
			</script>
		</script>


		<script type="text/ng-template" id="/add_info.html">
			<div class="container">
				<h2>{{New}} {{Article}} </h2>
				<form class="form-horizontal" ng-submit="submitForm()" role="form">
				<!-- method="post" action="/api/stock/">-->
					<div class="row">
						<div class="col-xs-10 col-lg-10">
							<div class="form-group">
			    				<label class="control-label	col-lg-3" for="metalTxt">Metal:</label>
							    <div class="col-lg-9">
									<input type="text" disabled="true" class="input-lg form-control" id="metalTxt" value="{{metal}}">
								</div>
			  				</div>
			  				
			  				<div class="form-group">
			    				<label class="control-label col-lg-3" for="categoryTxt">Category:</label>
							    <div class="col-lg-9">
									<input type="text" disabled="true" class="input-lg form-control" id="categoryTxt" value="{{category_name}}">
								</div>
			  				</div>
			  				
			  				<div class="form-group">
			    				<label class="control-label	col-lg-3" for="wagesTxt">{{Wages}} : </label>
							    <div class="col-lg-8">
									<input type="text" ng-model="wagesVal" name="wages" class="input-lg form-control" id="wagesTxt" value="0">
								</div>
								<span class="col-lg-1">
									&#8377;<!--rupees-->
								</span>
			  				</div>
			  				
			  				<div class="form-group">
			    				<label class="control-label	col-lg-3" for="netweightTxt">{{netWeight}} : </label>
							    <div class="col-lg-8">
									<input type="text" ng-model="netweightVal" name="netweight" class="input-lg form-control" id="netweightTxt" required="true" >
								</div>
								<span class="col-lg-1">
									{{weight_unit}}
								</span>
			  				</div>
			  				
			  				<div class="form-group">
			    				<label class="control-label	col-lg-3" for="grossweightTxt">{{grossWeight}} : </label>
							    <div class="col-lg-8">
									<input type="text" ng-model="grossweightVal" name="grossweight" class="input-lg form-control" id="grossweightTxt" required="true">
								</div>
								<span class="col-lg-1">
									{{weight_unit}}
								</span>
			  				</div>
			  				
			  				<div class="form-group">
			    				<label class="control-label	col-lg-3" for="caratTxt">{{Carat}} : </label>
							    <div class="col-lg-9">
									<input type="text" ng-model="caratVal" name="carat" class="input-lg form-control" id="caratTxt" required="true">
								</div>
			  				</div>

	  					</div>
	  					<div class="col-xs-2 col-lg-2">
	  						<img src="{{category_src}}" style="width: 90%" />
	  					</div>
	  				</div>
	  				<input type="hidden"  name="metal" value="{{metal_eng}}"></input>
	  				<input type="hidden"  name="category" value="{{category_id}}"></input>
 	  				<button type="submit" id="sbt_btn" class="center-block btn btn-primary btn-lg">Submit</button>
	  			</form>
			</div>
		</script>
		<script>
			$(function(){
				window.toggle = $("#langToggle").bootstrapToggle({
					on: 'English',
						off: 'Marathi',
						offstyle:"warning"
				}).change(function() {
					window.scope.lang = $(this).prop('checked') ? "eng" : "mar";

					if(window.obj){
						l([window.obj]);
					}
					Cookies.set("my_lang_settings", window.scope.lang);
				});
				var lang = Cookies.get("my_lang_settings");

				if(lang){
					window.scope.lang = lang;
				}else{
					if(!window.scope.lang){
						window.toggle.bootstrapToggle("off");
					}
				}
				if(window.scope.lang == "eng"){
					window.toggle.bootstrapToggle('on');
				}

				window.scope.$watch('lang', function() {
					if(window.scope.lang){
						window.toggle.bootstrapToggle((window.scope.lang == "eng")?'on':'off');
					}
				});
			});
			angular.module('app', [
	    		'ngRoute',
	    		'ui.bootstrap'
	    	])
	    	.config(['$routeProvider', function ($routeProvider) {
			    $routeProvider
					.when('/', {
			        	templateUrl: '/home.html',
			        	controller: 'homeController'
			      	})
			      	.when('/Gold', {
						templateUrl: '/categories.html',
						controller: 'categoriesController'
			      	})
			      	.when('/Silver', {
						templateUrl: '/categories.html',
						controller: 'categoriesController'
			      	})
			      	.when('/Gold/addCategory', {
						templateUrl: '/add_category.html',
						controller: 'add_categoryController'
			      	})
			      	.when('/Silver/addCategory', {
						templateUrl: '/add_category.html',
						controller: 'add_categoryController'
			      	})
			      	.otherwise({
						templateUrl: '/add_info.html',
						controller: 'add_infoController'
					});
					
			}])
			.controller('homeController', ['$location', '$scope', '$http', function ($location, $scope, $http) {
				window.scope = $scope;
				window.http = $http;
				
				var lang = Cookies.get("my_lang_settings");
				if(window.scope.lang != lang){
					window.scope.lang = lang;
				}
				
				l([{gold:"Gold", silver:"Silver", New:"New", Article:"Article"}]);
			}])
			.controller('categoriesController', ['$http', '$scope', '$routeParams', '$location', function ($http, $scope, $routeParams, $location) {
				window.scope = $scope;
				window.http = $http;
				
				var lang = Cookies.get("my_lang_settings");
				if(window.scope.lang != lang){
					window.scope.lang = lang;
				}
				$scope.$watch('lang', function() {
					if(window.obj){
						l([window.obj,function(){
							if(window.data_data){
								for (var i = 0; i < window.data_data.length; i++) {
									if(window.scope[window.data_data[i]]){
										$scope.categories[i].name = window.scope[window.data_data[i]];
									}
								}
							}
						}]);
					}
				});

				var a=($location.path().split("/"));

				$scope.metal = a[1];
				$scope.metal_eng = a[1];
				$scope.btnClass = "btn-"+((a[1] == "Gold")?"warning":"default");
				
				$scope.onCat = function (){
					window.location.href='#/'+$scope.metal_eng+'/addCategory';
				}
				

				$http.get('/api/categories/'+a[1]).success(function(data){
	        		$scope.categories = data;
	        		var obj = {};
	        		obj.metal = a[1];
	        		obj.New = "New";
	        		obj.Article = "Article";
	        		obj.Category = "Category";
	        		window.data_data = [];
	        		for (var i = 0; i < data.length; i++) {
	        			obj[data[i].name] = data[i].name;
	        			window.data_data.push(data[i].name);
	        			$scope.categories[i].image = base64ArrayBuffer(data[i].image.data.data);
	        		}
	        		var lang = Cookies.get("my_lang_settings");
					
					if(lang){
						window.scope.lang = lang;
					}
	        		l([obj,function(){
						for (var i = data.length - 1; i >= 0; i--) {
		        			$scope.categories[i].name = $scope[data[i].name];
		        		}
	        		}]);
	      		}).error(function(data, status){
	        		$scope.categories = [];
	      		});
    		}])
			.controller('add_categoryController', ['$scope', '$http', '$location', function($scope, $http, $location) {
				window.scope = $scope;
				window.http = $http;

				var a=($location.path().split("/"));

				$scope.metal = a[1];
				$scope.metal_eng = a[1];
				

				l([{New:"New", Category:"Category", metal:a[1]}]);
				var lang = Cookies.get("my_lang_settings");
				if(window.scope.lang != lang){
					window.scope.lang = lang;
				}
				
				$scope.submitForm = function() {
					$("#sbt_btn").html("Uploading...").attr("disabled","true");
					var eng = $scope.engVal;
					var mar = $scope.marVal;
					var data_uri = window.image_uri;
					data_uri = data_uri.substring(data_uri.indexOf(",") + 1);
					var obj = {name : eng};
					obj.image = {};
					obj.metal = $scope.metal_eng;
					obj.image.contentType = window.mime;
					obj.image.data = data_uri;
					//obj = JSON.stringify(obj);
					$.ajax({
						url: '/api/categories',
						type: 'POST',
						contentType: 'application/json',
						data: JSON.stringify(obj),
						dataType: 'json'
					}).done(function(data) {
						
						$.ajax({
							url: "/api/localize/mar/"+eng,
							type: 'PUT',
							data: JSON.stringify({mar:mar}),
							contentType: "application/json",
							success: function(){
								$("#sbt_btn")
					        		.removeClass("btn-primary")
					        		.addClass("btn-success")
					        		.html("Uploaded Successfully....");
					        	setTimeout(function(){
					        		window.location.href = "/";
					        	},1000);
							}
						});
					}).fail(function(data) {
					});
				};
			}])
			.controller('add_infoController', ['$location', '$scope', '$http', function ($location, $scope, $http) {
				window.scope = $scope;
				window.http = $http;
				
				var a=($location.path().split("/"));
				$http
					.get("/api/categories/"+a[2])
					.success(function(data){
						$scope.metal_eng = a[1];
						$scope.category_id = data._id;
						$scope.category_src ="data:image/png;base64," + base64ArrayBuffer(data.image.data.data);;
						l([{ metal:a[1], 
							category_name: data.name, 
							Wages:"Wages", 
							weight_unit:"grams", 
							New:"New", 
							Article:"Article",
							Weight:"Weight",
							grossWeight : "Gross Weight",
							netWeight : "Net Weight",
							Carat : "Carat"
						}]);
						
						$(function(){
							$scope.weightVal = 0.0;
							$scope.wagesVal = 0;
							$("#wagesTxt").numpad();
							$("#caratTxt").numpad();
							
							$("#netweightTxt").numpad();
							$("#grossweightTxt").numpad();

						});
						$scope.submitForm = function() {

							$("#sbt_btn").html("Adding...").attr("disabled","true");
							var obj ={};
							obj.netWeight = parseFloat($scope.netweightVal);
							obj.grossWeight = parseFloat($scope.grossweightVal);
							obj.carat = parseFloat($scope.caratVal);
							

							obj.wages = parseFloat($scope.wagesVal);
							obj.category = $scope.category_id;
							obj.metal = $scope.metal_eng;

							$.post("/api/stock", obj, function(s, r){
								console.log(s);
								console.log(r);

								if(s._id){
									$("#sbt_btn")
						        		.removeClass("btn-primary")
						        		.addClass("btn-success")
						        		.html("Added Successfully....");
						        	setTimeout(function(){
						        		window.location.href = "/";
						        	},1000);
								}
							});
				        };
					});
    		}]);
		</script>
	</body>
</html>